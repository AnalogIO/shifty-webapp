@namespace Components
@using System.ComponentModel.DataAnnotations
@using Shifty.App.Services
@using Shifty.Api.Generated.AnalogCoreV1
@using Shifty.Api.Generated.AnalogCoreV2
@inject IProductService _productService
@inject IVoucherService _voucherService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<MudContainer>
    <MudCard Class="mb-auto" Width="40vw">
        <MudCardContent>
            <MudText Align="Align.Center" Class="mb-n4">Issue Voucher Form</MudText>
            <MudForm @bind-IsValid="@_isFormValid" >
                <MudSelect  T="ProductDto" 
                            Label="Product"
                            Placeholder="Available products..."
                            AnchorOrigin="Origin.BottomCenter"
                            ToStringFunc="@_converter"
                            Required="true"
                            RequiredError="Product is required"
                            @bind-Value=_voucherForm.Product>

                    @foreach (var product in _products)
                    {
                        <MudSelectItem Value="@product" />
                    }
                </MudSelect>

                <MudNumericField @bind-Value="_voucherForm.Amount"
                                Placeholder="1" 
                                Label="Amount" 
                                Variant="Variant.Text" 
                                Required="true"
                                RequiredError="Product is required" 
                                Min="1"
                                Max="10" />

                <MudTextField T="string"
                    @bind-Value="_voucherForm.Description"
                    Label="Description" 
                    Required="true"
                    RequiredError="Description is required" />
                
                <MudCardActions>
                    <MudButton  Variant="Variant.Filled"
                                Color="Color.Primary"
                                Class="ml-auto"
                                Disabled="@(!_isFormValid)"
                                OnClick="@(async () => await IssueVoucher())"
                                EndIcon="@Icons.Material.Filled.Sell">
                        Issue Voucher
                    </MudButton>
                </MudCardActions>
            </MudForm>
            @if (_showProgressBar)
            {
                <MudContainer class="d-flex justify-content-center">
                    <MudProgressCircular hidden="@_showProgressBar" Color="Color.Default" Indeterminate="true" />
                </MudContainer>
            }
            @if (_showResult)
            {
                <MudTextField Text="@_voucherCodes"  
                            @ref="_multilineReference"
                            T="string"
                            Adornment="Adornment.End" 
                            Style="border-width: 2px; padding: 4px;" 
                            Outlined="true" 
                            AdornmentIcon="@Icons.Material.Outlined.ContentCopy"
                            OnAdornmentClick="@(async () => await CopyToClipboard())" 
                            Lines="@_vouchers.Count" 
                            ReadOnly=true />
            }
        </MudCardContent>
    </MudCard>
</MudContainer>

@code
{
    private VoucherForm _voucherForm = new();
    private bool _isFormValid = false;
    private bool _productsLoaded = false;
    private bool _showResult = false;
    private bool _showProgressBar = false;
    private ICollection<ProductDto> _products = new List<ProductDto>();
    private ICollection<IssueVoucherResponse> _vouchers;
    private string _voucherCodes;
    private MudTextField<string> _multilineReference;
    
    private class VoucherForm
    {
        [Required]
        public string Description { get; set; }
        public ProductDto Product { get; set; }
        public int Amount { get; set; } = 1;
    }

    protected override async Task OnInitializedAsync()
    {
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
        (_productsLoaded, _products) = await _productService.GetProducts();

        if (!_productsLoaded)
        {
            Snackbar.Add("Fatal error loading products", Severity.Error);
            Console.WriteLine("Error happened while loading products...");
        }
    }

    private async Task CopyToClipboard()
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", _voucherCodes);
        Snackbar.Add("Codes copied to clipboard", Severity.Success);
    }

    private async Task IssueVoucher()
    {
        _showResult = false;
        _showProgressBar = true;
        (var success, _vouchers) = await _voucherService.IssueVouchers(amount: _voucherForm.Amount, productId: _voucherForm.Product.Id, description: _voucherForm.Description);
        if (success)
        {
            _showProgressBar = false;
            _voucherCodes = string.Join("\n", _vouchers.Select(response => response.VoucherCode));
            _showResult = true;
        }
        else
        {
            _showProgressBar = false;
            _showResult = false;
            Snackbar.Add("Fatal error issuing voucher(s).", Severity.Error);
        }
    }
    
    Func<ProductDto,string> _converter = p => p != null ? $"{p.Name} ({p.NumberOfTickets})" : "";
}