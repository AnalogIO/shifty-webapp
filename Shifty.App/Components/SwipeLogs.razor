@namespace Components
@using System.ComponentModel.DataAnnotations
@using Shifty.App.Services
@using Shifty.Api.Generated.AnalogCoreV1
@using Shifty.Api.Generated.AnalogCoreV2
@using Shared
@using LanguageExt.UnsafeValueAccess
@using Shifty.App.Repositories
@using Microsoft.AspNetCore.SignalR.Client;
@using Microsoft.Extensions.Configuration
@using Microsoft.Extensions.Options
@using Shifty.App.DomainModels
@using Shifty.App.Settings
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject ITicketService TicketService
@inject ApiOptions ApiOptions

<MudPaper Elevation="15" Style="margin: 2em; border-radius: 5px;">
    @if (_loading)
    {
        <MudContainer Style="width: 100%; display: flex;">
            <LoadingIndicator Height="400px"/>
        </MudContainer>
    }
    else
    {
        <MudContainer Style="width: 100%; display: flex;">
            <MudTimeline>
                @foreach (var ticket in _usedTickets)
                {
                    <MudTimelineItem>
                        <MudTimelineContent>
                            <MudTypography Variant="Variant.H6" Color="Color.Primary">@ticket.UserName swiped a @ticket.MenuItemName using @ticket.ProductName</MudTypography>
                            <MudTypography Variant="Variant.Subtitle1" Color="Color.TextSecondary">@ticket.DateUsed</MudTypography>
                        </MudTimelineContent>
                    </MudTimelineItem>
                }
            </MudTimeline>
        </MudContainer>
    }
</MudPaper>

@code
{
    private bool _loading = true;
    private HubConnection _hubConnection;
    private List<UsedTicketEvent> _usedTickets = [];

    protected override async Task OnInitializedAsync()
    {
        var result = await TicketService.GetRecentlyUsedTickets(10);
        result.Match(
            Succ: usedTickets =>
            {
                Snackbar.Add("Fetched recently swiped tickets", Severity.Success);
                _usedTickets.AddRange(usedTickets.ToList());
                StateHasChanged();
            }, 
            Fail: error => Snackbar.Add(error.Message, Severity.Error)
        );
        
        _hubConnection = new HubConnectionBuilder()
            .WithUrl($"{ApiOptions.ApiHost}/used_tickets")
            .Build();
        
        _hubConnection.On<UsedTicketEvent>("UsedTicket", async usedTicketEvent =>
        {
            _usedTickets = _usedTickets.Prepend(usedTicketEvent).ToList();
            await InvokeAsync(StateHasChanged);
        });

        await _hubConnection.StartAsync();
        _loading = false;
    }
}